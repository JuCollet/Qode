"use strict";angular.module("app",["ui.router","ngResource"]).config(["$stateProvider","$urlRouterProvider",function(e,t){t.otherwise("/getqode"),e.state("root",{abstract:!0,views:{nav:{templateUrl:"views/nav.html"},content:{template:'<div ui-view="contentView"></div>'}}}).state("root.getqode",{url:"/getqode",params:{encode:null},views:{"options@root":{templateUrl:"views/navSwitch.html",controller:"NavController as nav"},"contentView@root":{templateUrl:"views/qodeGet.html",controller:"QodeGetController as qode"}}}).state("root.search",{url:"/search",params:{encode:null},views:{"options@root":{templateUrl:"views/navSwitch.html",controller:"NavController as nav"},"contentView@root":{templateUrl:"views/qodeSearch.html",controller:"QodeSearchController as qode"}}}).state("root.editqode",{url:"/new/:qode",views:{"contentView@root":{templateUrl:"views/qodeEdit.html",controller:"QodeEditController as edit"},"newQodePreview@root.editqode":{templateUrl:"views/qodePreview.html"}}}).state("root.viewqode",{url:"/qode/:qode",views:{"options@root":{templateUrl:"views/navBack.html"},"contentView@root":{templateUrl:"views/qodeView.html",controller:"QodeViewController as view"}}}).state("root.login",{url:"/login",views:{"options@root":{templateUrl:"views/navBack.html"},"contentView@root":{templateUrl:"views/userLogin.html",controller:"UserController as user"}}}).state("root.register",{url:"/register",views:{"options@root":{templateUrl:"views/navBack.html"},"contentView@root":{templateUrl:"views/userRegister.html",controller:"UserController as user"}}}).state("root.recovery",{url:"/recovery",views:{"contentView@root":{templateUrl:"views/userRecovery.html",controller:"UserController as user"}}}).state("root.recoveryrequest",{url:"/recoveryrequest",views:{"options@root":{templateUrl:"views/navBack.html"},"contentView@root":{templateUrl:"views/userRecoveryRequest.html",controller:"UserController as user"}}}).state("root.myaccount",{url:"/myaccount",views:{"options@root":{templateUrl:"views/navBack.html"},"contentView@root":{templateUrl:"views/userAccount.html",controller:"UserController as user"}}})}]);var uiModule=function(){var e,t,o;return e=function(t){var o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=$(".qode-code")[0].children;setTimeout(function(){return o<t.length?n<t[0].length?($(r[o]).text(t[n][o]),n++,void e(t,o,n)):(n=0,o++,void e(t,o,n)):void(o=0)},25)},t=function(e,t,o,n){var r=document.search.char1,a=document.search.char2,i=document.search.char3,s=document.search.char4,c=document.search.char5,l=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],d=function(){r.value="",a.value="",i.value="",s.value="",c.value=""},u=function(e){return-1===l.indexOf(e.toUpperCase())},f=function(e){var t=parseInt(e,10);return""!==t&&t>=0&&t<10};switch($("#status").html("&nbsp;"),e){case 1:if(u(r.value))return void(r.value="");a.focus();break;case 2:if(u(a.value))return void(a.value="");i.focus();break;case 3:if(!f(i.value))return void(i.value="");s.focus();break;case 4:if(!f(s.value))return void(s.value="");c.focus();break;case 5:if(!f(c.value))return void(c.value="");if(""!==r.value&&""!==a.value&&""!==i.value&&""!==s.value&&""!==c.value){$("#status").html('<i class="fa fa-refresh fa-spin"></i>&nbsp;&nbsp;Searching...');var m=(r.value+a.value+i.value+s.value+c.value).toUpperCase();t(m).then(function(e){document.activeElement.blur(),$("#status").html('<i class="fa fa-check is-green"></i>&nbsp;&nbsp;Found'),o(function(){d(),$("#status").html("&nbsp;"),n.go("root.viewqode",{qode:m})},500)},function(e){$("#status").html('<i class="fa fa-times is-red"></i>&nbsp;&nbsp;'+e.statusText+" :("),document.activeElement.blur(),d()})}else d(),document.activeElement.blur()}},o=function(e,t){return"http://"===e.substring(7,0)||"https://"===e.substring(8,0)||"www."===e.substring(4,0)||(t.$broadcast("notification",{color:"red",message:"No valid url found",title:"Oops...",glyph:"fa fa-times"}),!1)},{displayQodes:e,searchQodesHandler:t,testValidUrl:o}}(),uploadModule=function(){var e,t,o,n;return e=function(e,n,r){var a=document.getElementById("fileUpload").files[0];null!==a&&void 0!==a&&(t.disable(),a.size<10485760?o(a,r,e,n):(e.$broadcast("notification",{color:"red",title:"Oops...",message:"This file is too big",glyph:"fa fa-tachometer"}),t.activate()))},n=function(e,o,n,r,a,i){i({method:"PUT",url:o,data:e}).then(function(o){var n=void 0;e.name.length>20&&(n=e.name.split(""),n.splice(20,n.length-20),n.push("..."),n=n.join(""));var a=o.config.url.split("?")[0];r(n||e.name,a,e.type.split("/")[1].toUpperCase()),t.activate()},function(){a.$broadcast("notification",{color:"red",title:"Oops...",message:"Try again later",glyph:"fa fa-times"}),t.activate()})},o=function(e,o,r,a){a({method:"GET",url:"/sign-s3?file-name="+e.name+"&file-type="+e.type}).then(function(t){n(e,t.data.signedRequest,t.data.url,o,r,a)},function(){r.$broadcast("notification",{color:"red",title:"Oops...",message:"Try again later",glyph:"fa fa-times"}),t.activate()})},t={activate:function(){$("#ulButton").removeClass("is-light").addClass("button-yellow"),$("#ulButton span").text("Add file"),$("#ulButton i").removeClass("fa-spinner fa-spin").addClass("fa-plus"),$("#ulButton input").attr("disabled",!1)},disable:function(){$("#ulButton").addClass("is-light").removeClass("button-yellow"),$("#ulButton span").text("Uploading..."),$("#ulButton i").removeClass("fa-plus").addClass("fa-spinner fa-spin"),$("#ulButton input").attr("disabled",!0)}},{uploadFile:e}}();!function(){function e(e,t){var o,n,r=function(t){return e.get("/api/qodes/"+t)},a=function(t){return e.post("/api/qodes/edit/",{qode:t})},i=function(t,o){return e.put("/api/qodes/"+t,o)},s=function(t){return e.post("/api/qodes/",{qode:t})},c=function(t){return e.post("/api/qodes/upvote/",{toUpvote:t})},l=function(t){return e.post("/api/qodes/check/",{qode:t})},d=function(t){return e.put("/user/addtofavorites/",{favId:t})};return o=function(e,t,o){l(e).then(function(e){e.data.isAvailable?t():o()},function(e){return e})},n=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,n=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];return t(function(t,r){for(var a=[],i=0;i<e;i++){for(var s="",c=0;c<5;c++)s+=c<2?n[Math.floor(24*Math.random())]:Math.floor(10*Math.random());a.push(s)}o(a[e-1],function(){t(a)},function(){r("error")})})},{getQode:r,getQodeToEdit:a,createQode:s,saveQode:i,upVote:c,addToFavorites:d,doCheckIfAvailable:o,makeMockQodes:n}}e.$inject=["$http","$q"],angular.module("app").factory("qodeFactory",e)}(),function(){function e(e){return{getUser:function(){return e.get("/user")},addToFavorites:function(t){return e.put("/user/addtofavorites",{favId:t})},deleteQode:function(t){return e.delete("/user/deleteqode/"+t)},isLogged:function(){return e.get("/user/isLogged")},login:function(t){return e.post("/user/login",t)},logout:function(){return e.get("/user/logout")},recovery:function(t){return e.post("/user/passwordrecovery",{mail:t})},register:function(t){return e.post("/user",t)},reset:function(t){return e.put("/user",{newPassword:t})},removeFromFavorites:function(t){return e.put("/user/removefromfavorites",{favId:t})}}}e.$inject=["$http"],angular.module("app").factory("userFactory",e)}(),function(){function e(e,t,o,n){var r=this;r.$notification=$("notification"),r.backButtonDestination="root.getqode",r.notification={color:"",messageTitle:"",message:"",glyph:""},e.currentUser={isLogged:!1,name:""},function(){n.isLogged().then(function(t){void 0!==t.data.isLogged&&!0===t.data.isLogged.log?(e.currentUser.isLogged=!0,e.currentUser.name=t.data.isLogged.name):(e.currentUser.isLogged=!1,e.currentUser.name="")},function(e){if(e)throw e})}(),function(){e.$on("$stateChangeSuccess",function(e,t,o,n){null!==n.name&&void 0!==n.name&&("root.myaccount"===n.name?r.backButtonDestination="root.myaccount":"root.login"===n.name?r.backButtonDestination="root.login":"root.search"===n.name?r.backButtonDestination='root.search({encode:"decode"})':r.backButtonDestination="root.getqode")})}(),function(){e.$on("notification",function(e,n){r.notification.color=n.color,r.notification.messageTitle=n.title,r.notification.message=n.message,r.notification.glyph=n.glyph,t.$applyAsync(function(){$("body > div").addClass("is-blurred"),r.$notification.fadeIn(250).delay(1500).fadeOut(500)}),o(function(){$("body > div").removeClass("is-blurred")},2250)})}()}e.$inject=["$rootScope","$scope","$timeout","userFactory"],angular.module("app").controller("AppController",e)}(),function(){function e(e){var t=this,o=e.params.encode||"encode",n=$(".switch"),r=$(".switch-cursor");(function(){"encode"===o?r.css({marginLeft:"4px"}):r.css({marginLeft:"34px"})})(),t.switchToggle=function(){"decode"===o?r.animate({marginLeft:"4px"},50,function(){e.go("root.getqode",{encode:"encode"})}):r.animate({marginLeft:"34px"},50,function(){e.go("root.search",{encode:"decode"})})},n.tooltip({show:200,hide:500})}e.$inject=["$state"],angular.module("app").controller("NavController",e)}(),function(){function e(e,t,o,n,r,a){function i(e){g.newQode.files.splice(e,1)}function s(e,t){g.newQode.cards[e].cardReferences.splice(t,1)}function c(){g.confirm=!g.confirm}function l(){v++,v===p.length&&(v=1),g.newQode.cards.push(new h(p[v]))}function d(e,o,n){if(uiModule.testValidUrl(o,t))return""!==o&&""!==n?void g.newQode.cards[e].cardReferences.push(new w(n,o)):""!==g.newReference.url?void g.newQode.cards[e].cardReferences.push(new w(n,o)):void t.$broadcast("notification",{color:"red",message:"No reference to add",title:"Oops...",glyph:"fa fa-times"})}function u(e){$("#card"+e+">.card-delete").fadeOut(50,function(){$("#card"+e).slideUp(200,function(){g.newQode.cards.splice(parseInt(e,10),1),o.$apply()})})}function f(){if(void 0===g.newQode.title||g.newQode.title.length<2)return t.$broadcast("notification",{color:"red",message:"You forgot the title",title:"Oops...",glyph:"fa fa-times"}),void g.confirmToggle();r.saveQode(g.newQode._id,g.newQode).then(function(){t.$broadcast("notification",{color:"green",message:"Your Qode is online",title:"Congratulations !",glyph:"fa fa-check"}),a(function(){e.go("root.viewqode",{qode:g.newQode.qode})},1500)})}var m,g=this;g.removeFile=i,g.removeReference=s,g.confirmToggle=c,g.confirm=!1,g.addNewCard=l,g.addReference=d,g.deleteCard=u,g.postQode=f;var p=["default","orange","yellow","green","blue","purple"],v=0;g.newReference={url:"",name:""};var h=function(e){this.cardTitle="",this.cardText="",this.cardReferences=[],this.color=e},w=function(e,t){this.text=e,this.link=t},y=function(e,t,o){this.fileName=e,this.filePath=t,this.fileType=o};m=function(e,t,o){g.newQode.files.push(new y(e,t,o))},function(){r.getQodeToEdit(e.params.qode).then(function(e){g.newQode=e.data},function(o){e.go("root.getqode"),t.$broadcast("notification",{color:"red",message:o.data.error.message,title:"Oops...",glyph:"fa fa-times"})})}(),function(){document.getElementById("fileUpload").onchange=function(){g.newQode.files.length<5?uploadModule.uploadFile(t,n,m):t.$broadcast("notification",{color:"red",message:"5 files maximum",title:"Sorry...",glyph:"fa fa-times"})}}(),function(){$(".card-color-choice").click(function(e){var t=$(this),o=$(this).parents()[1];"true"===t.attr("data-isSelected")?($(".card-color-choice").removeAttr("data-isSelected"),$(o).attr("data-color","default")):($(".card-color-choice").removeAttr("data-isSelected"),t.attr("data-isSelected",!0),$(o).attr("data-color",e.currentTarget.id.substr(11)))})}()}e.$inject=["$state","$rootScope","$scope","$http","qodeFactory","$timeout"],angular.module("app").controller("QodeEditController",e)}(),function(){function e(e,t,o,n){function r(){t.makeMockQodes(5).then(function(e){s=e[e.length-1],uiModule.displayQodes(e)},function(){i.refresh()})}function a(){t.doCheckIfAvailable(s,function(){o.isLogged().then(function(o){void 0!==o.data.isLogged&&!0===o.data.isLogged.log?t.createQode(s).then(function(){n.go("root.editqode",{qode:s})}):e.$broadcast("notification",{color:"red",message:"You're not logged",title:"Oops...",glyph:"fa fa-times"})})},function(){e.$broadcast("notification",{color:"red",message:"It's not available anymore",title:"Oops...",glyph:"fa fa-times"})})}var i=this,s=void 0;i.refresh=r,i.getThis=a,i.refresh()}e.$inject=["$rootScope","qodeFactory","userFactory","$state"],angular.module("app").controller("QodeGetController",e)}(),function(){function e(e,t,o){this.keyPressed=function(n){uiModule.searchQodesHandler(n,e.getQode,t,o)}}e.$inject=["qodeFactory","$timeout","$state"],angular.module("app").controller("QodeSearchController",e)}(),function(){function e(e,t,o,n,r){function a(t){e.upVote(t).then(function(){s.qode.upVotes++,s.qode.isLiked=!0})}function i(e){t.addToFavorites(e).then(function(){s.qode.isFavorited=!0})}var s=this;s.likeThis=a,s.addToFavorites=i,function(){e.getQode(n.qode).then(function(e){s.qode=e.data},function(e){o.$broadcast("notification",{color:"red",message:e.data.error.message,title:"Oops...",glyph:"fa fa-times"}),r.go("root.getqode",{encode:"encode"})})}()}e.$inject=["qodeFactory","userFactory","$rootScope","$stateParams","$state"],angular.module("app").controller("QodeViewController",e)}(),function(){function e(e,t,o){function n(){return m.infos.password===m.infos.confirmPassword}function r(){var n={mail:m.infos.mail,password:m.infos.password};o.login(n).then(function(o){e.currentUser={isLogged:!0,name:o.data.name},t.go("root.getqode",{encode:"encode"})},function(t){e.$broadcast("notification",{color:"red",message:t.data.error.message,title:"Oops...",glyph:"fa fa-times"})})}function a(){o.logout().then(function(){e.currentUser={isLogged:!1,name:""}},function(){e.$broadcast("notification",{color:"red",message:"Please try again",title:"Oops...",glyph:"fa fa-times"})})}function i(){var r={name:m.infos.name,mail:m.infos.mail,password:m.infos.password,confirmPassword:m.infos.confirmPassword};if(!n())return void e.$broadcast("notification",{color:"red",message:"doesn't match",title:"Passwords",glyph:"fa fa-times"});o.register(r).then(function(o){e.currentUser={isLogged:!0,name:o.data.name},e.$broadcast("notification",{color:"green",message:"You're in, "+o.data.name,title:"Welcome",glyph:"fa fa-check"}),t.go("root.getqode",{encode:"encode"})},function(t){e.$broadcast("notification",{color:"red",message:t.data.error.message,title:"Oops...",glyph:"fa fa-times"})})}function s(e){t.go("root.viewqode",{qode:e})}function c(e,t){m.infos.favorites.splice(t,1),o.removeFromFavorites(e)}function l(e,t){m.infos.myqodes.splice(t,1),o.deleteQode(e)}function d(e){t.go("root.editqode",{qode:e})}function u(){o.recovery(m.infos.mail).then(function(){e.$broadcast("notification",{color:"green",message:"Check your emails.",title:"Alright !",glyph:"fa fa-check"}),t.go("root.getqode")},function(t){e.$broadcast("notification",{color:"red",message:t.data.error.message,title:"Oops..",glyph:"fa fa-times"})})}function f(){o.reset(m.infos.confirmPassword).then(function(){e.$broadcast("notification",{color:"green",message:"Password reset",title:"Alright !",glyph:"fa fa-check"}),t.go("root.getqode")})}var m=this;m.passwordValidation=n,m.login=r,m.logout=a,m.register=i,m.viewQode=s,m.removeFromFavorites=c,m.deleteQode=l,m.editQode=d,m.recovery=u,m.resetPassword=f,m.infos={name:"",mail:"",password:"",confirmPassword:""},function(){!0===e.currentUser.isLogged&&o.getUser().then(function(e){m.infos=e.data})}()}e.$inject=["$rootScope","$state","userFactory"],angular.module("app").controller("UserController",e)}(),angular.module("app").directive("notification",function(){return{restrict:"E",templateUrl:"views/notification.html"}}).directive("confirmation",function(){return{restrict:"E",templateUrl:"views/confirmation.html"}});